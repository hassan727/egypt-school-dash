# خطة الاستيراد الذكي (Smart Excel Import Strategy)

في أنظمة الاستيراد الجماعي من Excel، المشكلة ليست في "وجود البيانات"، بل في **عدم انتظام التنسيق** الذي يُدخله المستخدم.
لذا، لا يمكن الاعتماد على "نسخ البيانات كما هي".
بل يجب تصميم **استيراد ذكي** يفهم النوايا، يصحح الأخطاء، ويُوحّد التنسيقات تلقائيًّا — تمامًا كما تفعل أنظمة المؤسسات الكبرى.

عند استلام ملف Excel يحتوي على رؤوس الأعمدة التالية:

- الاسم الرباعي (عربي)
- الرقم القومي للطالب
- الجنسية
- النوع (ذكر/أنثى)
- المرحلة الدراسية
- الفصل
- السنة الدراسية (e.g. 2025-2026)
- اسم ولي الأمر
- رقم هاتف ولي الأمر
- رقم واتساب ولي الأمر
- رقم قومي ولي الأمر
- وظيفة ولي الأمر
- اسم الأم
- رقم هاتف الأم

يجب أن يعمل النظام وفق خطوات ذكية:

## أولًا: التحقق من رؤوس الأعمدة (Headers Validation)
- يقارن النظام رؤوس الملف مع القائمة الرسمية.
- يدعم أسماء بديلة (مثل: "الصف" بدل "المرحلة الدراسية"، أو "موبايل الأب" بدل "رقم هاتف ولي الأمر").
- إذا وُجد عمود غير معروف → يُهمَل أو يُطلب توضيحه.

## ثانيًا: التعامل مع تنسيق الأرقام (خاصة الرقم القومي وأرقام الهواتف)
**المشكلة**: Excel يُحوّل `29510200000000` إلى `2.95102E+13` (صيغة علمية).
**الحل**:
- النظام يقرأ الخلية **كنص (Text)** دائمًا، لا كرقم.
- إذا وُجد تنسيق علمي → يُعيد تحويله إلى رقم كامل باستخدام دقة 15 خانة.
- ثم يُحقق:
  - **الرقم القومي**: يجب أن يكون 14 رقمًا → إذا قلّ أو زاد → خطأ.
  - **أرقام الهواتف**: يجب أن تكون 11 رقمًا تبدأ بـ `01` → يُحوّلها تلقائيًّا إلى الصيغة الدولية: `201xxxxxxxxx`.

**مثال**:
- المدخل: `1111585527`
- النظام يكتشف أنه رقم هاتف (11 رقمًا، يبدأ بـ `01`)
- يُحوّله إلى: `201111585527`
- ويستخدم هذا الرقم في:
  - روابط واتساب
  - الإشعارات
  - عرض ولي الأمر

## ثالثًا: التعامل مع المراحل والفصول
**المشكلة**: المستخدم يكتب "1a" بينما النظام يتوقع "1A".
**الحل**:
- النظام يُجري "تطبيع نصي" (Text Normalization):
  - يحول الأحرف إلى **كابيتال**: `1a` → `1A`
  - يزيل المسافات الزائدة
  - يدعم أسماء بديلة:
    - "الصف الاول" = "الصف الأول الابتدائي"
    - "اول ابتدائي" = "الصف الأول الابتدائي"
- ثم يتحقق:
  - هل هذه "المرحلة" موجودة في جدول `stages_classes`؟
  - هل هذا "الفصل" مرتبط بهذه المرحلة؟
  - إذا لم يُوجد → يُسجّل خطأ في تقرير الاستيراد، ولا يُدخل السجل.

## رابعًا: السنة الدراسية
- يتأكد أن الشكل: `2025-2026` (أربعة أرقام – شرطة – أربعة أرقام)
- إذا كُتب: `2025/2026` أو `2025` → يُصلحها تلقائيًّا أو يرفضها مع رسالة واضحة.

## خامسًا: النصوص (الأسماء، المهن، الجنسية)
- يدعم اللغة العربية والإنجليزية
- يزيل الرموز غير الضرورية (مثل: `*`, `_`, `.`)
- يرفض السطور الفارغة أو الأسماء الأقل من حرفين

## سادسًا: توليد تقرير أخطاء ذكي
بعد الاستيراد، يعرض النظام:
- عدد السجلات الناجحة
- عدد السجلات المرفوضة
- جدول يحتوي على:
  - رقم السطر
  - السبب (مثال: "رقم قومي غير صالح"، "فصل غير مرتبط بالمرحلة")
  - القيمة الخاطئة
  - القيمة المقترحة (إن وُجدت)

## سابعًا: التعامل مع تكرار البيانات
- إذا وُجد طالب بنفس الرقم القومي → يُحدّث بياناته (بدلاً من إنشاء نسخة مكررة)
- مع خيار للمستخدم: "تحديث" أم "تخطي"

---

**النتيجة**:
ملف Excel يُرسله أي مستخدم — حتى لو غير متقن —
يُعالج تلقائيًّا،
يُصحح أخطاء التنسيق،
ويُدخل البيانات **كما لو كُتبت يدويًّا داخل النظام**،
مع الحفاظ على:
- سلامة الهيكل (المراحل، الفصول، السنوات)
- دقة الأرقام (قومي، هواتف)
- وضوح السجلات (أخطاء + تقارير)

هذا هو الاستيراد الذكي:
لا يطلب من المستخدم أن يكون خبيرًا.
بل يجعل النظام خبيرًا بما يكفي ليفهم المستخدم — حتى في أخطائه.
