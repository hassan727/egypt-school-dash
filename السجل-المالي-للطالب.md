# هيكلية وإدارة مالية شاملة ومتكاملة لملف الطالب

## مقدمة: المشكلة الجوهرية والفشل الحالي

النظام الحالي يفشل في إدارة البيانات المالية لأنه يتعامل معها كـ "معاملة فورية" وليس كـ "سجل مستمر". هذا يؤدي إلى:
- **فوضى عشوائية:** عدم وجود تنظيم زمني للبيانات.
- **ضياع التاريخ:** استحالة الوصول إلى بيانات سنة دراسية سابقة بسهولة.
- **منطق معطوب:** إجبار المستخدم على "إنشاء" بيانات مالية جديدة بدلاً من "إدارة" السجل الموجود.
- **غياب المرجعية:** عدم وجود مكان واحد وموثوق لجميع العمليات المالية للطالب.

## المبدأ التوجيهي: الانتقال من الفورم المسطح إلى السجل الزمني المنظم

الحل هو التخلي التام عن فكرة الفورم الواحد، وتبني هيكلية جديدة قائمة على **الزمن والتصنيف**. كل طالب لديه "ملف مالي شامل"، وهذا الملف يحتوي على "سجلات مالية سنوية".

---

## الهيكلية المقترحة: طبقات البيانات المالية

### الطبقة الأولى: السجل المالي الشامل للطالب (Master Financial Record)
هذا هو الحاوية الرئيسية لكل ما يتعلق بالطالب "علي" مثلاً. لا يحتوي على أرقام بقدر ما يحتوي على روابط للسجلات السنوية.

### الطبقة الثانية: السجل المالي لكل سنة دراسية (Annual Financial Record)
هذه هي أهم طبقة. كل سنة دراسية (مثل 2024/2025، 2023/2024) لها ملف مالي مستقل ومنظم تماماً. **عند الدخول على الإدارة المالية، أول ما يجب أن يظهر هو اختيار السنة الدراسية.**

### الطبقة الثالثة: مكونات السجل السنوي (Components of the Annual Record)
داخل كل سنة دراسية، تنقسم البيانات إلى قسمين رئيسيين:

#### القسم أ: الملف الأساسي للمصروفات (Base Fee File)
هذا هو الإعداد المبدئي للسنة. يتم إنشاؤه **مرة واحدة فقط** عند تسجيل الطالب لهذه السنة.
- **المرحلة الدراسية:** (مثال: الصف الرابع الابتدائي).
- **المبلغ الإجمالي للمصروفات الدراسية:** (يتم تحديده تلقائياً بناءً على المرحلة).
- **تفاصيل الأقساط:** (عدد الأقساط، مبلغ كل قسط، تاريخ استحقاق كل قسط).
- **الدفعة المقدمة:** (إن وجدت).
- **المصروفات الأخرى المبدئية:** (مثل النقل إذا تم اختياره عند التسجيل).
- **ملاحظة هامة:** هذا الملف بعد إنشائه يصبح **للقراءة فقط (Read-Only)** لأغراض التدقيق. أي تعديل جوهري يجب أن يتم عبر عملية محددة مع تسجيل سبب التعديل.

#### القسم ب: سجل المعاملات المالية (Financial Transaction Log)
هذا هو قلب النظام الديناميكي. إنه **سجل زمني** يوثق **كل حركة مالية** تتم على الطالب في هذه السنة الدراسية. **لا يتم حذف أو تعديل معاملة تمت، بل يتم إضافة معاملة جديدة لتصحيحها.**

كل معاملة في السجل تحتوي على:
- **نوع المعاملة:**
    - `دفعة` (Payment)
    - `مصروف إضافي` (Additional Fee)
    - `خصم` (Discount)
    - `غرامة` (Penalty)
- **التاريخ:** تاريخ حدوث المعاملة.
- **المبلغ:** القيمة المالية للمعاملة.
- **الوصف/السبب:** (مثال: "سداد القسط الثاني"، "رسوم رحلة إلى الأقصر"، "خصم بسبب أخ").
- **الربط (اختياري):** إذا كانت المعاملة `دفعة`، يتم ربطها بالقسط الذي تم سداده.

---

## واجهة المستخدم وسير العمل (UI & Workflow)

عند الضغط على "الإدارة المالية" للطالب "علي":

### الخطوة 1: اختيار السنة الدراسية
تظهر واجهة بسيطة جداً تحتوي على:
- **قائمة منسدلة (Dropdown):** لاختيار السنة الدراسية (2024/2025,2025-2026 , 2026-2027, 2023/2022, ...).
- **زر "عرض":** لفتح السجل المالي للسنة المختارة.

### الخطوة 2: عرض لوحة التحكم المالية للسنة المختارة
بعد اختيار السنة (مثال 2024/2025)، تظهر لوحة مقسمة إلى منطقتين رئيسيتين:

#### المنطقة الأولى: الملخص المالي للسنة
- **إجمالي المستحق للسنة:** (مأخوذ من "الملف الأساسي للمصروفات").
- **إجمالي المدفوع:** (محسوب تلقائياً بجمع كل معاملات نوع `دفعة` في "سجل المعاملات").
- **إجمالي المصروفات الإضافية:** (محسوب تلقائياً بجمع كل معاملات نوع `مصروف إضافي`).
- **إجمالي الخصومات:** (محسوب تلقائياً بجمع كل معاملات نوع `خصم`).
- **الصافي المستحق:** (إجمالي المستحق + إجمالي المصروفات الإضافية - إجمالي الخصومات - إجمالي المدفوع).
- **حالة الأقساط:** عرض مرئي لحالة كل قسط (مدفوع، غير مدفوع، متأخر).

#### المنطقة الثانية: إجراءات إدارة السجل
هنا لا توجد حقول تعديل عشوائية. توجد أزرار إجراءات واضحة ومحددة:

1.  **زر "تسجيل دفعة جديدة":**
    - عند الضغط عليه، يظهر نموذج صغير يسأل: "اختر القسط المراد سداده"، "أدخل المبلغ"، "تاريخ الدفع".
    - عند الحفظ، يتم إضافة **معاملة جديدة** من نوع `دفعة` إلى "سجل المعاملات".

2.  **زر "إضافة مصروف إضافي":**
    - يظهر نموذج يسأل: "اختر النوع" (نقل، رحلة، إلخ)، "أدخل المبلغ"، "الوصف".
    - عند الحفظ، يتم إضافة **معاملة جديدة** من نوع `مصروف إضافي`.

3.  **زر "إضافة خصم":**
    - يظهر نموذج يسأل: "سبب الخصم"، "أدخل المبلغ".
    - عند الحفظ، يتم إضافة **معاملة جديدة** من نوع `خصم`.

4.  **زر "عرض سجل المعاملات الكامل":**
    - يفتح صفحة جديدة تعرض "سجل المعاملات المالي" كجدول زمني كامل، مع إمكانية البحث والفلترة حسب النوع أو التاريخ. هذا هو المرجع النهائي لكل شيء.

---

## منطق الحفظ والتخزين (How it Works Behind the Scenes)

1.  **عند تسجيل طالب جديد لسنة 2024/2025:** يتم إنشاء "ملف أساسي للمصروفات" لهذه السنة وربطه بالطالب.
2.  **عندما يسدد ولي الأمر قسطاً:** لا يتم تعديل أي رقم في "الملف الأساسي". بدلاً من ذلك، يتم إنشاء **إدخال جديد** في "سجل المعاملات" يفيد بأن "دفعة" بمبلغ معين قد تمت في تاريخ معين.
3.  **عند عرض لوحة التحكم:** الأرقام التي تراها (مثل "المسدد" و"المتبقي") ليست محفوظة بشكل ثابت، بل هي **محسوبة ديناميكياً في الوقت الفعلي** عن قراءة "سجل المعاملات" وتجميع الأرقام حسب النوع.

## النتيجة النهائية والفوائد

هذا الهيكل يحل كل المشاكل:
- **نظام غير عشوائي:** كل شيء منظم حسب السنة الدراسية.
- **تاريخ كامل ومتاح:** يمكنك الوصول إلى بيانات أي سنة دراسية سابقة بضغطة زر.
- **منطق سليم:** الفصل التام بين إنشاء السجل الأساسي مرة واحدة، وإدارة المعاملات اليومية.
- **مرجعية لا تتزعزع:** "سجل المعاملات" هو المصدر الحقيقي للحقيقة، ويمكن الرجوع إليه في أي خلاف.
- **مرونة كاملة:** يمكن إضافة أي نوع من المصروفات أو الخصومات دون كسر الهيكل الأساسي.