# ุฏููู ุงูุชุนุงูู ุงูุงุญุชุฑุงูู ูุน Supabase Migrations ๐

ูุฐุง ุงูุฏููู ุชู ุฅุนุฏุงุฏู ุจูุงุกู ุนูู ุชุญููู ุงูุฃุฎุทุงุก ุงูุชู ูุงุฌููุงูุงุ ูุถูุงู ุนุฏู ุชูุฑุงุฑ ูุดุงูู ุงูุชุถุงุฑุจ ุฃู ูุดู ุงูุฑูุน ูุณุชูุจูุงู.

## 1. ุชุณููุฉ ุงููููุงุช (ุงููุงุนุฏุฉ ุงูุฐูุจูุฉ) โฐ

**ุงููุดููุฉ ุงูุณุงุจูุฉ:** ุงุณุชุฎุฏุงู ุชุงุฑูุฎ ุงูููู ููุท (ูุซูุงู `20251214_hr.sql`).
**ููุงุฐุง ูุดูุชุ** ูุฃู Supabase ูุนุชูุฏ ุนูู ุงูุฑูู ูู ุจุฏุงูุฉ ุงูููู ูู "ุฑูู ุฅุตุฏุงุฑ". ูู ุฃูุดุฃุช ููููู ูู ููุณ ุงููููุ ุณูุญููุงู ููุณ ุงูุฑููุ ูุณูุฑูุถููุง ุงูุณูุฑูุฑ (Duplicate Version Key).

**โ ุงูุญู ุงูุตุญูุญ:**
ุงุณุชุฎุฏู ุฏุงุฆูุงู **ุงูุชูููุช ุงููุงูู** (ุงูุณูุฉ + ุงูุดูุฑ + ุงูููู + ุงูุณุงุนุฉ + ุงูุฏูููุฉ + ุงูุซุงููุฉ).
ูุฐุง ูุถูู ุฃู ูู ููู ูู "ุจุตูุฉ" ูุฑูุฏุฉ ูุณุชุญูู ุฃู ุชุชูุฑุฑ.

*ูุซุงู ุตุญูุญ:*
`20251215093015_add_salary_tables.sql`
(ุญูุซ 093015 ูู ุงูุณุงุนุฉ 9:30 ู 15 ุซุงููุฉ).

---

## 2. ูุชุงุจุฉ ููุฏ "ุฐูู ูุขูู" (Idempotency) ๐ก๏ธ

**ุงููุดููุฉ ุงูุณุงุจูุฉ:** ุงูุฃูุฑ `CREATE TRIGGER` ูุดู ูุฃูู ูุงู ููุฌูุฏุงู ูุณุจูุงู.
ุงููุฏู ูู ุฃู ููุชุจ ููุฏุงู ูููู ุชุดุบููู 10 ูุฑุงุช ุฏูู ุฃู ูุธูุฑ ุฃู ุฎุทุฃ ุฃุญูุฑ.

**โ ุงูููุงุนุฏ ุงูุฐูุจูุฉ ูููุชุงุจุฉ:**

### ุฃ. ุงูุฌุฏุงูู (Tables)
ูุง ุชูุชุจ `CREATE TABLE` ููุท.
ุงุณุชุฎุฏู:
```sql
CREATE TABLE IF NOT EXISTS table_name ( ... );
```

### ุจ. ุงูุฃุนูุฏุฉ (Columns)
ูุง ุชูุชุจ `ADD COLUMN` ูุจุงุดุฑุฉ. ุงุณุชุฎุฏู `IF NOT EXISTS` (ูุฏุนููุฉ ูู postgres 9.6+):
```sql
ALTER TABLE table_name ADD COLUMN IF NOT EXISTS col_name TYPE;
```
*ุฃู ูููุณุฎ ุงูุฃูุฏูุ ูุชู ูุถุนูุง ุฏุงุฎู ุจููู `DO $$ ... END $$` ููุญุต ูุฌูุฏ ุงูุนููุฏ.*

### ุฌ. ุงูุชุฑูุฌุฑุฒ (Triggers) - ูุงู ุฌุฏุงู! โ๏ธ
ุงูุชุฑูุฌุฑ ูู ุงูุฃูุซุฑ ุชุณุจุจุงู ูููุดุงูู ูุฃูู ูุง ูุฏุนู `CREATE OR REPLACE`.
**ุงูุญู:** ุงุญุฐูู ุฃููุงู ุซู ุฃูุดุฆู.

```sql
-- 1. ุงุญุฐู ุงููุฏูู (ุจุฃูุงู)
DROP TRIGGER IF EXISTS trigger_name ON table_name;

-- 2. ุฃูุดุฆ ุงูุฌุฏูุฏ
CREATE TRIGGER trigger_name
    BEFORE UPDATE ON table_name
    FOR EACH ROW
    EXECUTE FUNCTION ...;
```

---

## 3. ุฎุทูุงุช ุงูุนูู ุงููุซุงููุฉ (Workflow) ๐ฃ

ุนูุฏูุง ุชุฑูุฏ ุฅุถุงูุฉ ููุฒุฉ ุฌุฏูุฏุฉ:

1.  **ุฃูุดุฆ ุงูููู:** ุฏุงุฎู ูุฌูุฏ `migrations`ุ ุฃูุดุฆ ูููุงู ุฌุฏูุฏุงู ุจุงุณู ูุจุฏุฃ ุจุงูุชูููุช ุงูุญุงูู (ูุซูุงู `20251216120000_fix_bug.sql`).
2.  **ุงูุชุจ ุงูู SQL:** ุงุชุจุน ููุงุนุฏ ุงูุฃูุงู (Drop if exists / If not exists).
3.  **ุงุฑูุน ุงูุชุนุฏูู:**
    ```bash
    npm run db:push
    ```

---

## 4. ูุงุฐุง ุชูุนู ูู ุญุฏุซ ุฎุทุฃุ ๐ง

ุฅุฐุง ูุงู ูู ุงูุณูุฑูุฑ ุฃู ููุงู ุชุถุงุฑุจ ูู ุงูุชูุงุฑูุฎ (Migration History Mismatch):

1.  **ูุง ุชุญุฐู ุงููููุงุช.**
2.  ุงุณุชุฎุฏู ุฃูุฑ ุงูุฅุตูุงุญ ูุฅุฎุจุงุฑ ุงูุณูุฑูุฑ ุจุชุฌุงูู ุงูุฅุตุฏุงุฑุงุช ุงูุฎุงุทุฆุฉ:
    ```bash
    npx supabase migration repair --status reverted <ุฑูู_ุงูุฅุตุฏุงุฑ_ุงูุฎุงุทูุก>
    ```
3.  ุซู ุญุงูู ุงูุฑูุน ูุฑุฉ ุฃุฎุฑู.
